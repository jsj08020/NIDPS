<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>NIDPS ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center py-10">

  <!-- ì œëª© -->
  <h1 class="text-4xl font-bold text-blue-600 mb-10">NIDPS ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ</h1>

  <!-- ì¹´ë“œ ì˜ì—­ -->
  <div id="stats" class="grid grid-cols-2 md:grid-cols-4 gap-6 w-11/12 max-w-5xl mb-8">
    <div class="bg-white p-6 rounded-2xl shadow-md">
      <p class="text-gray-400">ì „ì²´ ë¡œê·¸ ìˆ˜</p>
      <p id="total" class="text-2xl font-semibold mt-2">-</p>
    </div>
    <div class="bg-white p-6 rounded-2xl shadow-md">
      <p class="text-gray-400">Ping íƒì§€</p>
      <p id="ping" class="text-2xl font-semibold mt-2 text-blue-500">-</p>
    </div>
    <div class="bg-white p-6 rounded-2xl shadow-md">
      <p class="text-gray-400">ë¹„ì •ìƒ ì ‘ê·¼</p>
      <p id="port" class="text-2xl font-semibold mt-2 text-red-500">-</p>
    </div>
    <div class="bg-white p-6 rounded-2xl shadow-md">
      <p class="text-gray-400">íŠ¸ë˜í”½ ê³¼ë‹¤</p>
      <p id="traffic" class="text-2xl font-semibold mt-2 text-orange-500">-</p>
    </div>
  </div>

  <!-- ì‹¤ì‹œê°„ ë¡œê·¸ ë°•ìŠ¤ -->
  <div class="bg-white rounded-2xl shadow-md w-11/12 max-w-5xl p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4">ğŸ“œ ì‹¤ì‹œê°„ íƒì§€ ë¡œê·¸</h2>
      <button id="clearBtn"
            class="px-3 py-2 mb-3 bg-red-500 text-white rounded text-sm">
        ë¡œê·¸ ì „ì²´ ì‚­ì œ
      </button>
    <div id="logBox" class="font-mono text-sm text-left h-96 overflow-y-auto border-t pt-3"></div>
  </div>

  <!-- AI ë¶„ì„ ë°•ìŠ¤ -->
  <div class="bg-white rounded-2xl shadow-md w-11/12 max-w-5xl p-6">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-xl font-semibold">ğŸ¤– AI íŠ¸ë˜í”½ ë¶„ì„ ê²°ê³¼</h2>
    </div>

    <!-- ì„ íƒëœ ë¡œê·¸ í‘œì‹œ -->
    <div class="mb-3">
      <p class="text-xs text-gray-500">ì„ íƒëœ ë¡œê·¸</p>
      <div id="selectedLog"
           class="text-xs text-gray-700 bg-gray-100 rounded px-2 py-1 mt-1 max-h-16 overflow-y-auto">
        (ì•„ì§ ì„ íƒëœ ë¡œê·¸ ì—†ìŒ)
      </div>

      <button id="analyzeBtn"
              class="mt-3 px-4 py-2 bg-blue-600 text-white rounded text-sm disabled:opacity-40"
              disabled>
        ì„ íƒí•œ ë¡œê·¸ ë¶„ì„í•˜ê¸°
      </button>
    </div>

    <!-- ë¶„ì„ ê²°ê³¼ ì¶œë ¥ -->
    <div id="analysisBox"
         class="font-mono text-sm text-left h-64 overflow-y-auto border-t pt-3 whitespace-pre-wrap">
      ì•„ì§ ë¶„ì„ ê²°ê³¼ ì—†ìŒ
    </div>
  </div>

<script>
  let lastLogs = [];
  const logBox = document.getElementById("logBox");
  let autoScroll = true;

  let selectedLog = null;
  const selectedLogEl = document.getElementById("selectedLog");
  const analyzeBtn = document.getElementById("analyzeBtn");

  // ìŠ¤í¬ë¡¤ ìë™ ì—¬ë¶€ ê°ì§€
  logBox.addEventListener("scroll", () => {
    const tolerance = 1;
    autoScroll =
      Math.abs(logBox.scrollHeight - logBox.scrollTop - logBox.clientHeight) <= tolerance;
  });

  // ë¡œê·¸ í´ë¦­ ì‹œ ì„ íƒ ì²˜ë¦¬
  function handleLogClick(line, element) {
    selectedLog = line;
    selectedLogEl.textContent = line;
    analyzeBtn.disabled = false;

    // í•˜ì´ë¼ì´íŠ¸ ì •ë¦¬
    document.querySelectorAll(".log-line").forEach(el => {
      el.classList.remove("bg-blue-100");
    });
    element.classList.add("bg-blue-100");
  }

  // ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°
  async function fetchLogs() {
    try {
      const res = await fetch("/api/logs");
      const data = await res.json();

      if (JSON.stringify(data) === JSON.stringify(lastLogs)) return;

      const newLogs = data.slice(lastLogs.length);
      newLogs.forEach(line => {
        const p = document.createElement("p");
        p.textContent = line;
        p.className = "log-line cursor-pointer hover:bg-gray-100";
        p.addEventListener("click", () => handleLogClick(line, p));
        logBox.appendChild(p);
      });

      if (logBox.children.length > 500) {
        for (let i = 0; i < 100; i++) {
          logBox.removeChild(logBox.firstChild);
        }
      }

      if (autoScroll) {
        logBox.scrollTop = logBox.scrollHeight;
      }

      document.getElementById("total").textContent = data.length;
      document.getElementById("ping").textContent = data.filter(l => l.includes("Ping")).length;
      document.getElementById("port").textContent = data.filter(l => l.includes("Port")).length;
      document.getElementById("traffic").textContent = data.filter(l => l.includes("íŠ¸ë˜í”½")).length;

      lastLogs = data;

    } catch (err) {
      console.error("ì„œë²„ ì—°ê²° ì‹¤íŒ¨:", err);
    }
  }

  // ì„ íƒí•œ ë¡œê·¸ AI ë¶„ì„
  async function analyzeSelectedLog() {
    if (!selectedLog) return;

    const box = document.getElementById("analysisBox");
    box.textContent = "ë¡œê·¸ ë¶„ì„ ì¤‘...";

    analyzeBtn.disabled = true;

    try {
      const res = await fetch("/api/analyze-log", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ line: selectedLog }),
      });

      const data = await res.json();
      box.textContent = data.result || "ë¶„ì„ ì‹¤íŒ¨";

    } catch (err) {
      console.error("ì„ íƒ ë¡œê·¸ ë¶„ì„ ì‹¤íŒ¨:", err);
      box.textContent = "ì˜¤ë¥˜ ë°œìƒ: ì„œë²„ ì—°ê²° ì‹¤íŒ¨";
    } finally {
      analyzeBtn.disabled = false;
    }
  }

  analyzeBtn.addEventListener("click", analyzeSelectedLog);

  // ë¡œê·¸ ì£¼ê¸°ì  ê°±ì‹ 
  fetchLogs();
  setInterval(fetchLogs, 2000);

 // ğŸ”¥ ë¡œê·¸ Clear ê¸°ëŠ¥
  document.getElementById("clearBtn").addEventListener("click", async () => {
    if (!confirm("ë¡œê·¸ë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?")) return;

    try {
      const res = await fetch("/api/clear-logs", {
        method: "POST"
      });

      if (!res.ok) {
        // ìƒíƒœì½”ë“œ 200ì´ ì•„ë‹ˆë©´ ì—ëŸ¬ ì²˜ë¦¬
        const text = await res.text();
        console.error("clear-logs ì‘ë‹µ ì—ëŸ¬:", res.status, text);
        alert("ì„œë²„ì—ì„œ ì—ëŸ¬ ì‘ë‹µì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤.");
        return;
      }

      const result = await res.json();

      if (result.status === "ok") {
        // UI ë¡œê·¸ ë¹„ìš°ê¸°
        logBox.innerHTML = "";
        lastLogs = [];

        // í†µê³„ ë¦¬ì…‹
        document.getElementById("total").textContent = 0;
        document.getElementById("ping").textContent = 0;
        document.getElementById("port").textContent = 0;
        document.getElementById("traffic").textContent = 0;

        alert("ë¡œê·¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!");
      } else {
        alert("ì˜¤ë¥˜ ë°œìƒ: " + result.message);
      }
    } catch (err) {
      console.error("clear-logs ìš”ì²­ ì‹¤íŒ¨:", err);
      alert("ì„œë²„ ì˜¤ë¥˜ë¡œ ì´ˆê¸°í™” ì‹¤íŒ¨");
    }
  });

</script>

</body>
</html>
