<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>NIDPS ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center py-10">

  <!-- ì œëª© -->
  <h1 class="text-4xl font-bold text-blue-600 mb-10">NIDPS ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ</h1>

  <!-- ì¹´ë“œ ì˜ì—­ -->
  <div id="stats" class="grid grid-cols-2 md:grid-cols-4 gap-6 w-11/12 max-w-5xl mb-8">
    <div class="bg-white p-6 rounded-2xl shadow-md">
      <p class="text-gray-400">ì „ì²´ ë¡œê·¸ ìˆ˜</p>
      <p id="total" class="text-2xl font-semibold mt-2">-</p>
    </div>
    <div class="bg-white p-6 rounded-2xl shadow-md">
      <p class="text-gray-400">Ping íƒì§€</p>
      <p id="ping" class="text-2xl font-semibold mt-2 text-blue-500">-</p>
    </div>
    <div class="bg-white p-6 rounded-2xl shadow-md">
      <p class="text-gray-400">ë¹„ì •ìƒ ì ‘ê·¼</p>
      <p id="port" class="text-2xl font-semibold mt-2 text-red-500">-</p>
    </div>
    <div class="bg-white p-6 rounded-2xl shadow-md">
      <p class="text-gray-400">íŠ¸ë˜í”½ ê³¼ë‹¤</p>
      <p id="traffic" class="text-2xl font-semibold mt-2 text-orange-500">-</p>
    </div>
  </div>

  <!-- í•„í„° ì˜ì—­ -->
  <div class="w-11/12 max-w-5xl mb-3 flex flex-col md:flex-row gap-3 justify-between">
    <div class="flex items-center gap-2">
      <label class="text-sm text-gray-600">ì‹¬ê°ë„</label>
      <select id="severityFilter" class="border rounded px-2 py-1 text-sm">
        <option value="ALL">ì „ì²´</option>
        <option value="ì‹¬ê°">ì‹¬ê°</option>
        <option value="ë†’ìŒ">ë†’ìŒ</option>
        <option value="ì¤‘ê°„">ì¤‘ê°„</option>
        <option value="ë‚®ìŒ">ë‚®ìŒ</option>
      </select>
    </div>

    <div class="flex items-center gap-2">
      <label class="text-sm text-gray-600">ê³µê²© ìœ í˜•</label>
      <select id="typeFilter" class="border rounded px-2 py-1 text-sm">
        <option value="ALL">ëª¨ë“  ìœ í˜•</option>
        <option value="í¬íŠ¸ ìŠ¤ìº”">í¬íŠ¸ ìŠ¤ìº”</option>
        <option value="SYNí”ŒëŸ¬ë“œ">SYNí”ŒëŸ¬ë“œ</option>
        <option value="SQL ì¸ì ì…˜">SQL ì¸ì ì…˜</option>
        <option value="ë¬´ì°¨ë³„ ëŒ€ì…">ë¬´ì°¨ë³„ ëŒ€ì…</option>
        <option value="DDOS">DDOS</option>
      </select>
    </div>
  </div>

  <!-- ì‹¤ì‹œê°„ ë¡œê·¸ ë°•ìŠ¤ -->
  <div class="bg-white rounded-2xl shadow-md w-11/12 max-w-5xl p-6 mb-6">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-xl font-semibold">ğŸ“œ ì‹¤ì‹œê°„ íƒì§€ ë¡œê·¸</h2>
      <button id="clearBtn"
              class="px-3 py-2 bg-red-500 text-white rounded text-sm">
        ë¡œê·¸ ì „ì²´ ì‚­ì œ
      </button>
    </div>
    <div id="logBox" class="font-mono text-sm text-left h-96 overflow-y-auto border-t pt-3"></div>
  </div>

  <!-- AI ë¶„ì„ ë°•ìŠ¤ -->
  <div class="bg-white rounded-2xl shadow-md w-11/12 max-w-5xl p-6">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-xl font-semibold">ğŸ¤– AI íŠ¸ë˜í”½ ë¶„ì„ ê²°ê³¼</h2>
    </div>

    <!-- ì„ íƒëœ ë¡œê·¸ í‘œì‹œ -->
    <div class="mb-3">
      <p class="text-xs text-gray-500">ì„ íƒëœ ë¡œê·¸</p>
      <div id="selectedLog"
           class="text-xs text-gray-700 bg-gray-100 rounded px-2 py-1 mt-1 max-h-16 overflow-y-auto">
        (ì•„ì§ ì„ íƒëœ ë¡œê·¸ ì—†ìŒ)
      </div>

      <button id="analyzeBtn"
              class="mt-3 px-4 py-2 bg-blue-600 text-white rounded text-sm disabled:opacity-40"
              disabled>
        ì„ íƒí•œ ë¡œê·¸ ë¶„ì„í•˜ê¸°
      </button>
    </div>

    <!-- ë¶„ì„ ê²°ê³¼ ì¶œë ¥ -->
    <div id="analysisBox"
         class="font-mono text-sm text-left h-64 overflow-y-auto border-t pt-3 whitespace-pre-wrap">
      ì•„ì§ ë¶„ì„ ê²°ê³¼ ì—†ìŒ
    </div>
  </div>

<script>
  let lastLogs = [];
  const logBox = document.getElementById("logBox");
  let autoScroll = true;

  let selectedLog = null;
  const selectedLogEl = document.getElementById("selectedLog");
  const analyzeBtn = document.getElementById("analyzeBtn");

  const severityFilterEl = document.getElementById("severityFilter");
  const typeFilterEl = document.getElementById("typeFilter");

  // ìŠ¤í¬ë¡¤ ìë™ ì—¬ë¶€ ê°ì§€
  logBox.addEventListener("scroll", () => {
    const tolerance = 1;
    autoScroll =
      Math.abs(logBox.scrollHeight - logBox.scrollTop - logBox.clientHeight) <= tolerance;
  });

  // í•„í„° ì ìš©
  function applyFilters() {
    const severityValue = severityFilterEl.value;
    const typeValue = typeFilterEl.value;

    document.querySelectorAll(".log-line").forEach(el => {
      const s = el.dataset.severity || "ì •ë³´";
      const t = el.dataset.type || "ê¸°íƒ€";

      const severityOk = (severityValue === "ALL") || (s === severityValue);
      const typeOk = (typeValue === "ALL") || (t === typeValue);

      el.style.display = (severityOk && typeOk) ? "" : "none";
    });
  }

  severityFilterEl.addEventListener("change", applyFilters);
  typeFilterEl.addEventListener("change", applyFilters);

  // ë¡œê·¸ í´ë¦­ ì‹œ ì„ íƒ ì²˜ë¦¬
  function handleLogClick(line, element) {
    selectedLog = line;
    selectedLogEl.textContent = line;
    analyzeBtn.disabled = false;

    // í•˜ì´ë¼ì´íŠ¸ ì •ë¦¬
    document.querySelectorAll(".log-line").forEach(el => {
      el.classList.remove("bg-blue-100");
    });
    element.classList.add("bg-blue-100");
  }

  // ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°
  async function fetchLogs() {
    try {
      const res = await fetch("/api/logs");
      const data = await res.json();

      if (JSON.stringify(data) === JSON.stringify(lastLogs)) return;

      const newLogs = data.slice(lastLogs.length);
      newLogs.forEach(line => {
        const p = document.createElement("p");
        p.textContent = line;
        p.className = "log-line cursor-pointer hover:bg-gray-100";

        // ----- ë¡œê·¸ í…ìŠ¤íŠ¸ì—ì„œ ì‹¬ê°ë„ íŒŒì‹± -----
        // í¬ë§· ì˜ˆ: [12:34:56] [ì‹¬ê°] ë©”ì‹œì§€...
        const matches = line.match(/\[(.*?)\]/g);
        let severityLabel = "ì •ë³´";
        if (matches && matches.length >= 2) {
          severityLabel = matches[1].replace("[", "").replace("]", "");
        }
        p.dataset.severity = severityLabel;

        // ì‹¬ê°ë„ì— ë”°ë¼ ìƒ‰ìƒ ì ìš©
        if (severityLabel === "ì‹¬ê°") p.classList.add("text-red-700");
        else if (severityLabel === "ë†’ìŒ") p.classList.add("text-red-500");
        else if (severityLabel === "ì¤‘ê°„") p.classList.add("text-orange-500");
        else if (severityLabel === "ë‚®ìŒ") p.classList.add("text-blue-500");

        // ----- ê³µê²© ìœ í˜• íƒœê¹… (ê°„ë‹¨ ë§¤í•‘) -----
        let attackType = "ê¸°íƒ€";

        if (line.includes("ë¹„ì •ìƒ Port")) {
          attackType = "í¬íŠ¸ ìŠ¤ìº”";
        } else if (line.includes("íŠ¸ë˜í”½ ê³¼ë‹¤")) {
          attackType = "DDOS";
        } else if (line.includes("Ping ê³¼ë‹¤")) {
          attackType = "SYNí”ŒëŸ¬ë“œ";
        }
        // ë‚˜ì¤‘ì— SQL ì¸ì ì…˜/ë¬´ì°¨ë³„ ëŒ€ì… íƒì§€ ì¶”ê°€í•˜ë©´ ì—¬ê¸° ë¶„ê¸°ë§Œ ë” ë„£ìœ¼ë©´ ë¨
        p.dataset.type = attackType;

        p.addEventListener("click", () => handleLogClick(line, p));
        logBox.appendChild(p);
      });

      // ë„ˆë¬´ ë§ìœ¼ë©´ ì˜¤ë˜ëœ ë¡œê·¸ ì œê±°
      if (logBox.children.length > 500) {
        for (let i = 0; i < 100; i++) {
          if (logBox.firstChild) logBox.removeChild(logBox.firstChild);
        }
      }

      if (autoScroll) {
        logBox.scrollTop = logBox.scrollHeight;
      }

      // í†µê³„ ì—…ë°ì´íŠ¸
      document.getElementById("total").textContent = data.length;
      document.getElementById("ping").textContent =
        data.filter(l => l.includes("Ping ìš”ì²­")).length;
      document.getElementById("port").textContent =
        data.filter(l => l.includes("ë¹„ì •ìƒ Port ì ‘ê·¼")).length;
      document.getElementById("traffic").textContent =
        data.filter(l => l.includes("íŠ¸ë˜í”½ ê³¼ë‹¤ ë°œìƒ")).length;

      lastLogs = data;

      // ìƒˆ ë¡œê·¸ ìƒê¸¸ ë•Œë§ˆë‹¤ í•„í„° ë‹¤ì‹œ ì ìš©
      applyFilters();

    } catch (err) {
      console.error("ì„œë²„ ì—°ê²° ì‹¤íŒ¨:", err);
    }
  }

  // ì„ íƒí•œ ë¡œê·¸ AI ë¶„ì„
  async function analyzeSelectedLog() {
    if (!selectedLog) return;

    const box = document.getElementById("analysisBox");
    box.textContent = "ë¡œê·¸ ë¶„ì„ ì¤‘...";

    analyzeBtn.disabled = true;

    try {
      const res = await fetch("/api/analyze-log", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ line: selectedLog }),
      });

      const data = await res.json();
      box.textContent = data.result || "ë¶„ì„ ì‹¤íŒ¨";

    } catch (err) {
      console.error("ì„ íƒ ë¡œê·¸ ë¶„ì„ ì‹¤íŒ¨:", err);
      box.textContent = "ì˜¤ë¥˜ ë°œìƒ: ì„œë²„ ì—°ê²° ì‹¤íŒ¨";
    } finally {
      analyzeBtn.disabled = false;
    }
  }

  analyzeBtn.addEventListener("click", analyzeSelectedLog);

  // ğŸ”¥ ë¡œê·¸ Clear ê¸°ëŠ¥
  document.getElementById("clearBtn").addEventListener("click", async () => {
    if (!confirm("ë¡œê·¸ë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?")) return;

    try {
      const res = await fetch("/api/clear-logs", {
        method: "POST"
      });

      if (!res.ok) {
        const text = await res.text();
        console.error("clear-logs ì‘ë‹µ ì—ëŸ¬:", res.status, text);
        alert("ì„œë²„ì—ì„œ ì—ëŸ¬ ì‘ë‹µì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤.");
        return;
      }

      const result = await res.json();

      if (result.status === "ok") {
        // UI ë¡œê·¸ ë¹„ìš°ê¸°
        logBox.innerHTML = "";
        lastLogs = [];

        // í†µê³„ ë¦¬ì…‹
        document.getElementById("total").textContent = 0;
        document.getElementById("ping").textContent = 0;
        document.getElementById("port").textContent = 0;
        document.getElementById("traffic").textContent = 0;

        // ì„ íƒ ë¡œê·¸ ë° ë¶„ì„ ê²°ê³¼ ì´ˆê¸°í™”
        selectedLog = null;
        selectedLogEl.textContent = "(ì•„ì§ ì„ íƒëœ ë¡œê·¸ ì—†ìŒ)";
        document.getElementById("analysisBox").textContent = "ì•„ì§ ë¶„ì„ ê²°ê³¼ ì—†ìŒ";
        analyzeBtn.disabled = true;

        alert("ë¡œê·¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!");
      } else {
        alert("ì˜¤ë¥˜ ë°œìƒ: " + result.message);
      }
    } catch (err) {
      console.error("clear-logs ìš”ì²­ ì‹¤íŒ¨:", err);
      alert("ì„œë²„ ì˜¤ë¥˜ë¡œ ì´ˆê¸°í™” ì‹¤íŒ¨");
    }
  });

  // ë¡œê·¸ ì£¼ê¸°ì  ê°±ì‹ 
  fetchLogs();
  setInterval(fetchLogs, 2000);
</script>

</body>
</html>
